<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dropdown Test</title>
</head>
<body>
    <h2>Test if dropdown functionality works at all</h2>
    <p>Click the buttons below to test dropdown functionality:</p>
    
    <button onclick="testBasicDropdown()">Test Basic Dropdown</button>
    <button onclick="testD4Dropdown()">Test D4 Dropdown with Real Data</button>
    
    <div id="testArea" style="margin: 20px; padding: 20px; border: 1px solid #ccc;">
        <div>Test Cell: <span id="testCell" style="padding: 5px 10px; border: 1px solid #999; display: inline-block; min-width: 200px; background: #fafafa;">Click a button above</span></div>
    </div>

    <script>
        // Create a working dropdown function
        function createDropdown(targetElement, values, currentValue) {
            console.log('Creating dropdown with', values.length, 'values');
            
            // Remove any existing dropdown
            const existing = document.getElementById('testDropdown');
            if (existing) existing.remove();
            
            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.id = 'testDropdown';
            dropdown.style.cssText = `
                position: absolute;
                background: white;
                border: 1px solid #ccc;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                max-height: 200px;
                overflow-y: auto;
                z-index: 10000;
                min-width: 200px;
            `;
            
            // Add options
            if (values.length === 0) {
                dropdown.innerHTML = '<div style="padding: 10px; color: #999;">No options available</div>';
            } else {
                values.forEach(value => {
                    const option = document.createElement('div');
                    option.textContent = value;
                    option.style.cssText = 'padding: 5px 10px; cursor: pointer;';
                    
                    if (value === currentValue) {
                        option.style.background = '#e3f2fd';
                    }
                    
                    option.onmouseover = () => option.style.background = '#f0f0f0';
                    option.onmouseout = () => option.style.background = value === currentValue ? '#e3f2fd' : 'white';
                    
                    option.onclick = () => {
                        targetElement.textContent = value;
                        dropdown.remove();
                        console.log('Selected:', value);
                    };
                    
                    dropdown.appendChild(option);
                });
            }
            
            // Position dropdown
            const rect = targetElement.getBoundingClientRect();
            dropdown.style.left = rect.left + 'px';
            dropdown.style.top = (rect.bottom + 2) + 'px';
            
            document.body.appendChild(dropdown);
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== targetElement) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }
        
        function testBasicDropdown() {
            const testCell = document.getElementById('testCell');
            const testValues = ['Option 1', 'Option 2', 'Option 3', 'Option 4', 'Option 5'];
            createDropdown(testCell, testValues, testCell.textContent);
        }
        
        async function testD4Dropdown() {
            const testCell = document.getElementById('testCell');
            testCell.textContent = 'Loading...';
            
            try {
                // Try to fetch real data from your API
                const response = await fetch('api/excel-api.php?action=worksheets&workbook_id=1');
                const worksheets = await response.json();
                
                // Find "Standar Jumlah" sheet
                const targetSheet = worksheets.find(ws => 
                    ws.sheet_name.includes('Standar Jumlah')
                );
                
                if (targetSheet) {
                    console.log('Found sheet:', targetSheet.sheet_name);
                    
                    // Fetch cells B5:B83
                    const cellsResponse = await fetch(
                        `api/excel-api.php?action=cell-range&worksheet_id=${targetSheet.id}` +
                        `&start_row=5&end_row=83&start_col=2&end_col=2`
                    );
                    const data = await cellsResponse.json();
                    
                    // Extract values
                    const values = [];
                    if (data.cells) {
                        data.cells.forEach(cell => {
                            if (cell.cell_value) {
                                values.push(cell.cell_value);
                            }
                        });
                    }
                    
                    console.log('Found', values.length, 'values');
                    testCell.textContent = 'Select an option';
                    createDropdown(testCell, values, '');
                    
                } else {
                    testCell.textContent = 'Sheet not found';
                    console.error('Standar Jumlah sheet not found');
                }
                
            } catch (error) {
                console.error('Error:', error);
                testCell.textContent = 'Error loading data';
            }
        }
    </script>
    
    <hr>
    
    <h3>Now let's fix your dashboard</h3>
    <p>Add this script to your index.html AFTER loading dashboard-final.js:</p>
    
    <pre style="background: #f5f5f5; padding: 10px; overflow-x: auto;">
&lt;script&gt;
// Global dropdown function that definitely works
window.showValidationDropdown = function(cellElement, cellAddress, formula) {
    console.log('showValidationDropdown called for', cellAddress);
    
    // Remove any existing dropdown
    const existing = document.getElementById('validationDropdown');
    if (existing) existing.remove();
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.id = 'validationDropdown';
    dropdown.style.cssText = `
        position: fixed;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        max-height: 250px;
        overflow-y: auto;
        z-index: 10000;
        min-width: 200px;
        border-radius: 4px;
    `;
    
    // Position it
    const rect = cellElement.getBoundingClientRect();
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = (rect.bottom + 2) + 'px';
    
    // Add loading message
    dropdown.innerHTML = '&lt;div style="padding: 10px; color: #666;"&gt;Loading options...&lt;/div&gt;';
    document.body.appendChild(dropdown);
    
    // Parse formula to get sheet and range
    const match = formula.match(/^'([^']+)'!\$?([A-Z]+)\$?(\d+):\$?([A-Z]+)\$?(\d+)$/);
    if (!match) {
        dropdown.innerHTML = '&lt;div style="padding: 10px; color: #999;"&gt;Invalid formula&lt;/div&gt;';
        return;
    }
    
    const sheetName = match[1];
    const startCol = match[2].charCodeAt(0) - 64; // Convert A=1, B=2, etc.
    const startRow = parseInt(match[3]);
    const endCol = match[4].charCodeAt(0) - 64;
    const endRow = parseInt(match[5]);
    
    console.log('Fetching from', sheetName, 'rows', startRow, '-', endRow, 'col', startCol);
    
    // Fetch the data
    fetch('api/excel-api.php?action=worksheets&workbook_id=' + (window.ExcelDashboard?.currentWorkbook || 1))
        .then(r => r.json())
        .then(worksheets => {
            const sheet = worksheets.find(ws => ws.sheet_name.includes(sheetName));
            if (!sheet) throw new Error('Sheet not found: ' + sheetName);
            
            return fetch(
                `api/excel-api.php?action=cell-range&worksheet_id=${sheet.id}` +
                `&start_row=${startRow}&end_row=${endRow}` +
                `&start_col=${startCol}&end_col=${endCol}`
            );
        })
        .then(r => r.json())
        .then(data => {
            const values = [];
            if (data.cells) {
                data.cells.forEach(cell => {
                    if (cell.cell_value && !values.includes(cell.cell_value)) {
                        values.push(cell.cell_value);
                    }
                });
            }
            
            console.log('Found', values.length, 'values');
            
            // Clear loading message
            dropdown.innerHTML = '';
            
            if (values.length === 0) {
                dropdown.innerHTML = '&lt;div style="padding: 10px; color: #999;"&gt;No options available&lt;/div&gt;';
            } else {
                values.forEach(value => {
                    const option = document.createElement('div');
                    option.textContent = value;
                    option.style.cssText = 'padding: 5px 10px; cursor: pointer;';
                    
                    option.onmouseover = () => option.style.background = '#f0f0f0';
                    option.onmouseout = () => option.style.background = 'white';
                    
                    option.onclick = () => {
                        cellElement.textContent = value;
                        dropdown.remove();
                        
                        // Save if dashboard is available
                        if (window.ExcelDashboard && window.ExcelDashboard.saveCell) {
                            window.ExcelDashboard.saveCell(cellAddress, value, cellElement);
                        }
                    };
                    
                    dropdown.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading values:', error);
            dropdown.innerHTML = '&lt;div style="padding: 10px; color: red;"&gt;Error loading options&lt;/div&gt;';
        });
    
    // Close on outside click
    setTimeout(() => {
        document.addEventListener('click', function closeDropdown(e) {
            if (!dropdown.contains(e.target) && e.target !== cellElement) {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
            }
        });
    }, 100);
};

// Override double-click for validation cells
window.setupValidationCells = function() {
    console.log('Setting up validation cells...');
    
    const validationCells = {
        'D4': "'Standar Jumlah'!$B$5:$B$83",
        'E4': "'Standar Jumlah'!$B$5:$B$83",
        'F4': "'Standar Jumlah'!$B$5:$B$83",
        'D5': "'List Aircraft'!$R$3:$R$42",
        'E5': "'List Aircraft'!$R$3:$R$42",
        'F5': "'List Aircraft'!$R$3:$R$42"
    };
    
    Object.entries(validationCells).forEach(([address, formula]) => {
        const cell = document.querySelector(`[data-address="${address}"]`);
        if (cell) {
            // Add arrow if not exists
            if (!cell.querySelector('.dropdown-arrow')) {
                cell.style.position = 'relative';
                const arrow = document.createElement('span');
                arrow.className = 'dropdown-arrow';
                arrow.innerHTML = '▼';
                arrow.style.cssText = `
                    position: absolute;
                    right: 2px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 10px;
                    color: #666;
                    pointer-events: none;
                `;
                cell.appendChild(arrow);
            }
            
            // Override double-click
            cell.ondblclick = (e) => {
                e.stopPropagation();
                e.preventDefault();
                window.showValidationDropdown(cell, address, formula);
            };
            
            console.log('✓ Setup validation for', address);
        }
    });
};

// Auto-setup after dashboard loads
setTimeout(window.setupValidationCells, 3000);
&lt;/script&gt;
    </pre>
</body>
</html>